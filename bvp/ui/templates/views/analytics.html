{% extends "base.html" %}

{% set active_page = "analytics" %}

{% block title %} Client analytics {% endblock %}

{% block divs %}

    <div class="container-fluid">
        <div class="row">
            <div class="col-sm-4 top-bottom">
                <h3>About</h3>
                <div class="justify">
                    <p>
                        This page provides in-depth analytics for your resources (individual assets or groups of assets).
                        You can browse through historical data and assess how that platform is monitoring and forecasting data streams from various resources.
                    </p>
                    {% if documentation_exists %}
                    <p>
                        Need help understanding this page? Check out the
                        <a href="{{ url_for('bvp_ui.static', filename='documentation/html/views/analytics.html') }}" target="_blank">documentation</a>.
                    </p>
                    {% endif %}
                </div>
                <h3>Controls</h3>
                <form id="resource-form" method="post">
                    <div class="form-group">
                        {% for asset_type in asset_types %}
                            <i class="icon-{{ asset_type }}"></i>
                        {% endfor %}
                        <label class="control-label" for="resource">Resource</label>
                        <div>
                            <select class="form-control" id="resource" name="resource" onchange="this.form.submit()">
                                {% for asset_group, asset_group_display_name in asset_groups %}
                                    <option value="{{ asset_group }}" {% if resource==asset_group %} selected="selected"{% endif %}>
                                        {{ asset_group_display_name }}
                                    </option>
                                {% endfor %}
                                {% for asset in assets %}
                                    <option value="{{ asset.name }}" {% if resource==asset.name %} selected="selected"{% endif %}>
                                        {{ asset.display_name }} ({{ asset.asset_type_display_name }})
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </form>
                {% block datetimepicker %} {{ super() }} {% endblock %}
                {% block forecastpicker %} {{ super() }} {% endblock %}
                <h3>Metrics</h3>
                <table class="table text-right" style="font-size: 100%;">
                    <thead>
                        <tr>
                            <th><i class="icon-calculator"></i></th>
                            <th>
                                <span title="Aggregation of the profile of this resource.">
                                    {% if showing_pure_consumption_data %} Consumption
                                    {% elif showing_pure_production_data %} Production
                                    {% else %} Production {% endif %} <!-- Todo: check for default mode of mixed asset groups -->
                                    (MWh)
                                </span>
                            </th>
                            <th><span title="The prices which are applicable to this resource.">Price (KRW/MWh)</span></th>
                            <th>
                                {% if showing_pure_consumption_data %}
                                <span title="The costs which {{ resource_display_name }} occurred or might occur."> Costs (KRW)</span>
                                {% elif showing_pure_production_data %}
                                <span title="The revenues which {{ resource_display_name }} occurred or might occur."> Revenues (KRW)</span>
                                {% else %}
                                <span title="The revenues or costs which {{ resource_display_name }} occurred or might occur."> Rev./Costs (KRW)</span>
                                {% endif %}
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="text-left">
                                Realised
                            </td>
                            <td>{% if metrics["realised_power_in_mwh"] %}
                                    {{ "{:,.3f}".format( metrics["realised_power_in_mwh"] | round(3) ) }}
                                {% else %}
                                    nan
                                {% endif %}
                            </td>
                            <td>{{ "{:,.2f}".format( metrics["realised_unit_price"] | round(2)) }}</td>
                            <td>{{ "{:,.2f}".format( metrics["realised_revenues_costs"] | round(2)) }}</td>
                        </tr>
                        <tr>
                            <td class="text-left">
                                Expected (forecast per {{ resolution_human }})
                            </td>
                            <td>{{ "{:,.3f}".format( metrics["expected_power_in_mwh"] | round(3) ) }}</td>
                            <td>{{ "{:,.2f}".format( metrics["expected_unit_price"] | round(2) ) }}</td>
                            <td>{{ "{:,.2f}".format( metrics["expected_revenues_costs"] | round(2) ) }}</td>
                        </tr>
                        <tr>
                            <td class="text-left">
                                MAE (per {{ resolution_human }})
                            </td>
                            <td>{{ "{:,.3f}".format( metrics["mae_power_in_mwh"] | round(3)) }}</td>
                            <td>{{ "{:,.2f}".format( metrics["mae_unit_price"] | round(2)) }}</td>
                            <td>{{ "{:,.2f}".format( metrics["mae_revenues_costs"] | round(2)) }}</td>
                        </tr>
                        <tr>
                            <td class="text-left">
                                WAPE
                            </td>
                            <td>{{ "{:,.1f}".format( metrics["wape_power"] | round(1)) }} %</td>
                            <td>{% if metrics["wape_unit_price"] %}
                                    {{ "{:,.1f}".format( metrics["wape_unit_price"] | round(1)) }} %
                                {% else %}
                                    nan
                                {% endif %}
                            </td>
                            <td>{% if metrics["wape_revenues_costs"] %}
                                    {{ "{:,.2f}".format( metrics["wape_revenues_costs"] | round(2)) }} %
                                {% else %}
                                    nan
                                {% endif %}
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="col-sm-8">
                <div class="panel panel-default">
                    {{ analytics_plots_div | safe }}
                    {{ analytics_plots_script | safe }}
                </div>
            </div>
        </div>
    </div>

{% endblock %}
