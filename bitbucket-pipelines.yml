codeCheckStep: &codeCheckStep
  step:
    name: Code check
    image: python:3.8.3
    script:
      # Running pre-commit, as it is repeatable from repo code
      - pip install pre-commit==2.2.0
      - pre-commit run --all-files --show-diff-on-failure

buildAndTestStep: &buildAndTestStep
  step:
    name: Build and Test
    image: python:3.8.3
    caches:
        - pip
    script:
        - ci/SETUP.sh
        - apt-get update
        - apt-get -y install postgresql-client coinor-cbc
        - PGPASSWORD=a1test psql -h localhost -p 5432 -c "create extension if not exists cube; create extension if not exists earthdistance;" -U a1test a1test;
        - make install-deps
        - python setup.py test
    services:
        - postgres

pipelines:
  default:
    - <<: *codeCheckStep
    - <<: *buildAndTestStep

  branches:
    master:
      - <<: *codeCheckStep
      - <<: *buildAndTestStep
      - step:
          name: Deploy to Staging
          deployment: staging
          script:
            - ci/DEPLOY.sh

definitions:
  services:
    postgres:
      image: postgres
      environment:
        POSTGRES_DB: a1test
        POSTGRES_USER: a1test
        POSTGRES_PASSWORD: a1test
        DATABASE_URL: postgres://a1test:a1test@127.0.0.1:5432/a1test
